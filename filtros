# Sistema de Filtros Completo - Documenta√ß√£o T√©cnica

## üìã Vis√£o Geral

Este documento explica **exatamente** como funciona o sistema de filtros de im√≥veis em leil√£o. O sistema usa **Supabase** como banco de dados e **React Router** para gerenciar filtros na URL.

**Volume de dados:** ~16.000 im√≥veis  
**Tecnologias:** React, TypeScript, Supabase (PostgreSQL), React Router

---

## üèóÔ∏è Arquitetura do Sistema

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   URL Params    ‚îÇ ‚Üê Usu√°rio acessa URL com filtros
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ useFilterParams ‚îÇ ‚Üê Hook l√™ filtros da URL
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Estado Filters ‚îÇ ‚Üê Filtros aplicados no estado
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Supabase Query ‚îÇ ‚Üê Query constru√≠da com filtros
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Resultados     ‚îÇ ‚Üê 40 itens por p√°gina
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üì¶ Estrutura de Arquivos Necess√°rios

```
src/
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îî‚îÄ‚îÄ useFilterParams.tsx      # Hook para gerenciar filtros na URL
‚îú‚îÄ‚îÄ integrations/
‚îÇ   ‚îî‚îÄ‚îÄ supabase/
‚îÇ       ‚îî‚îÄ‚îÄ client.ts             # Cliente do Supabase
‚îî‚îÄ‚îÄ utils/
    ‚îî‚îÄ‚îÄ stringUtils.ts            # Utilit√°rios (sanitiza√ß√£o, escape SQL)
```

---

## üîß Arquivo 1: Hook de Filtros (`useFilterParams.tsx`)

### Fun√ß√£o Principal

Este hook gerencia a sincroniza√ß√£o entre **URL** e **estado dos filtros**.

```typescript
import { useSearchParams } from 'react-router-dom';
import { useCallback } from 'react';

export interface FilterParams {
  city?: string;                    // Cidade √∫nica ou m√∫ltiplas (separadas por v√≠rgula)
  type?: string;                    // Tipo de im√≥vel √∫nico ou m√∫ltiplos
  neighborhood?: string;            // Bairro √∫nico ou m√∫ltiplos
  location?: string;                // Busca livre em endere√ßo/bairro/cidade
  keyword?: string;                 // Busca em t√≠tulo/descri√ß√£o
  hasSecondAuction?: boolean;       // Apenas com segundo leil√£o
  priceRange?: { min?: number; max?: number; };
  priceRanges?: string[];           // Labels das faixas selecionadas
  financiamento?: boolean;          // Aceita financiamento
  fgts?: boolean;                   // Aceita FGTS
  parcelamento?: boolean;           // Permite parcelamento
  auctionType?: string;             // Tipo de leil√£o (Judicial, Extrajudicial, etc.)
  neighborhoods?: string[];         // Array de bairros
  cities?: string[];                // Array de cidades
  dataFimSegundoLeilao?: string;    // Data final (ISO)
  zone?: string;                    // Zona √∫nica
  zones?: string[];                 // M√∫ltiplas zonas
}

export const useFilterParams = () => {
  const [searchParams, setSearchParams] = useSearchParams();

  // CONVERTE URL ‚Üí OBJETO FILTROS
  const parseFiltersFromURL = useCallback((): FilterParams => {
    const filters: FilterParams = {};
    
    // L√™ cada par√¢metro da URL e converte para o objeto
    const city = searchParams.get('cidade');
    if (city) filters.city = city;
    
    // ... (l√™ todos os outros par√¢metros)
    
    return filters;
  }, [searchParams]);

  // CONVERTE OBJETO FILTROS ‚Üí URL
  const updateURL = useCallback((filters: FilterParams) => {
    const newParams = new URLSearchParams();
    
    if (filters.city) newParams.set('cidade', filters.city);
    // ... (adiciona todos os outros par√¢metros)
    
    setSearchParams(newParams, { replace: true });
  }, [setSearchParams]);

  return {
    parseFiltersFromURL,  // URL ‚Üí Filtros
    updateURL,             // Filtros ‚Üí URL
    clearFiltersFromURL,    // Limpar URL
    getShareableURL,       // Obter URL atual
    createShareableURL      // Criar URL com filtros
  };
};
```

### Como Funciona

1. **parseFiltersFromURL()**: L√™ `?cidade=Rio&tipo=Apartamento` da URL e retorna `{ city: "Rio", type: "Apartamento" }`
2. **updateURL()**: Recebe `{ city: "Rio" }` e atualiza a URL para `?cidade=Rio`
3. **Sincroniza√ß√£o**: Sempre que filtros mudam, a URL √© atualizada (e vice-versa)

---

## üîß Arquivo 2: Cliente Supabase (`client.ts`)

```typescript
import { createClient } from '@supabase/supabase-js';

const SUPABASE_URL = "https://seu-projeto.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "sua-chave-publica";

export const supabase = createClient(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);
```

**Fun√ß√£o:** Cria conex√£o com o banco de dados Supabase.

---

## üîß Arquivo 3: Utilit√°rios (`stringUtils.ts`)

### Fun√ß√µes de Seguran√ßa

```typescript
// ESCAPA caracteres especiais do SQL para prevenir SQL Injection
export const escapeSqlLike = (str: string): string => {
  return str
    .replace(/\\/g, '\\\\')  // Escapa \
    .replace(/%/g, '\\%')    // Escapa %
    .replace(/_/g, '\\_')    // Escapa _
    .replace(/'/g, "''");    // Escapa '
};

// REMOVE caracteres problem√°ticos antes de buscar
export const sanitizeSearchInput = (str: string): string => {
  return str
    .replace(/[,;]/g, '')  // Remove v√≠rgulas e ponto e v√≠rgula
    .trim();
};
```

**Por que s√£o necess√°rias?**
- **escapeSqlLike**: Previne SQL Injection em buscas com `ILIKE`
- **sanitizeSearchInput**: Remove caracteres que podem quebrar a query

---

## üéØ Arquivo 4: L√≥gica de Busca (Exemplo Completo)

### Fluxo Completo de uma Busca

```typescript
import { useState, useEffect } from 'react';
import { supabase } from '@/integrations/supabase/client';
import { useFilterParams, FilterParams } from '@/hooks/useFilterParams';
import { escapeSqlLike, sanitizeSearchInput } from '@/utils/stringUtils';

const ITEMS_PER_PAGE = 40;

export const PropertyList = () => {
  const [properties, setProperties] = useState([]);
  const [filters, setFilters] = useState<FilterParams>({});
  const [currentPage, setCurrentPage] = useState(1);
  const [filtersLoaded, setFiltersLoaded] = useState(false);

  const { parseFiltersFromURL, updateURL } = useFilterParams();

  // PASSO 1: Carregar filtros da URL ao montar
  useEffect(() => {
    const urlFilters = parseFiltersFromURL();
    setFilters(urlFilters);
    setFiltersLoaded(true);
  }, []);

  // PASSO 2: Buscar im√≥veis quando filtros ou p√°gina mudarem
  useEffect(() => {
    if (!filtersLoaded) return;
    
    const fetchProperties = async () => {
      // PASSO 3: Criar query base
      let query = supabase
        .from('leiloes_imoveis_com_zona')
        .select('*', { count: 'exact' })
        .eq('estado', 'RJ')           // Filtro base: apenas RJ
        .gte('leilao_1', 75000);      // Filtro base: m√≠nimo R$ 75k

      // PASSO 4: Aplicar filtros sequencialmente
      
      // FILTRO 1: Cidade
      if (filters.city) {
        const cidades = filters.city.split(',');
        if (cidades.length > 1) {
          query = query.in('cidade', cidades);  // M√∫ltiplas cidades
        } else {
          query = query.eq('cidade', filters.city);  // Uma cidade
        }
      }

      // FILTRO 2: Tipo de im√≥vel
      if (filters.type) {
        const tipos = filters.type.split(',');
        if (tipos.length > 1) {
          query = query.in('tipo_propriedade', tipos);
        } else {
          query = query.eq('tipo_propriedade', filters.type);
        }
      }

      // FILTRO 3: Bairro
      if (filters.neighborhood) {
        const bairros = filters.neighborhood.split(',');
        if (bairros.length > 1) {
          query = query.in('bairro', bairros);
        } else {
          query = query.eq('bairro', filters.neighborhood);
        }
      }

      // FILTRO 4: Localiza√ß√£o (busca OR em 3 campos)
      if (filters.location) {
        const sanitized = sanitizeSearchInput(filters.location);
        const escaped = escapeSqlLike(sanitized);
        // Busca em endereco OU bairro OU cidade
        query = query.or(
          `endereco.ilike.%${escaped}%,` +
          `bairro.ilike.%${escaped}%,` +
          `cidade.ilike.%${escaped}%`
        );
      }

      // FILTRO 5: Palavra-chave (busca OR em 2 campos)
      if (filters.keyword) {
        const sanitized = sanitizeSearchInput(filters.keyword);
        const escaped = escapeSqlLike(sanitized);
        // Busca em t√≠tulo OU descri√ß√£o
        query = query.or(
          `titulo_propriedade.ilike.%${escaped}%,` +
          `descricao.ilike.%${escaped}%`
        );
      }

      // FILTRO 6: Segundo leil√£o
      if (filters.hasSecondAuction) {
        // Apenas im√≥veis que T√äM segundo leil√£o (n√£o √© null)
        query = query
          .not('data_leilao_2', 'is', null)
          .not('leilao_2', 'is', null);
      }

      // FILTRO 7: Faixa de pre√ßo
      if (filters.priceRange) {
        if (filters.priceRange.min !== undefined) {
          query = query.gte('leilao_1', filters.priceRange.min);  // >= min
        }
        if (filters.priceRange.max !== undefined) {
          query = query.lte('leilao_1', filters.priceRange.max);  // <= max
        }
      }

      // FILTRO 8: Tipo de leil√£o (l√≥gica especial)
      if (filters.auctionType) {
        if (filters.auctionType === "EXTRAJUDICIAL_CUSTOM") {
          // Todos os extrajudiciais (n√£o √© Judicial nem Outros)
          query = query
            .neq('tipo_leilao', 'Judicial')
            .neq('tipo_leilao', 'Outros');
        } else if (filters.auctionType === "Judicial") {
          // Judicial OU Outros
          query = query.in('tipo_leilao', ['Judicial', 'Outros']);
        } else {
          // Tipo espec√≠fico
          query = query.eq('tipo_leilao', filters.auctionType);
        }
      }

      // FILTRO 9: Financiamento
      if (filters.financiamento === true) {
        query = query.eq('financiamento', true);
      }

      // FILTRO 10: FGTS
      if (filters.fgts === true) {
        query = query.eq('fgts', true);
      }

      // FILTRO 11: Parcelamento
      if (filters.parcelamento === true) {
        query = query.eq('parcelamento', true);
      }

      // FILTRO 12: Data final do segundo leil√£o
      if (filters.dataFimSegundoLeilao) {
        query = query.lte('data_leilao_2', filters.dataFimSegundoLeilao);
      }

      // FILTRO 13: Apenas leil√µes futuros (autom√°tico)
      const currentDate = new Date();
      let countQuery = query;
      if (!filters.dataFimSegundoLeilao) {
        // Inclui se: data_leilao_1 √© null OU >= hoje OU data_leilao_2 >= hoje
        countQuery = countQuery.or(
          `data_leilao_1.is.null,` +
          `data_leilao_1.gte.${currentDate.toISOString()},` +
          `data_leilao_2.gte.${currentDate.toISOString()}`
        );
      }

      // PASSO 5: Obter contagem total (para pagina√ß√£o)
      const countResult = await countQuery;
      const total = countResult.count || 0;
      const totalPages = Math.ceil(total / ITEMS_PER_PAGE);

      // PASSO 6: Aplicar pagina√ß√£o
      const from = (currentPage - 1) * ITEMS_PER_PAGE;
      const to = from + ITEMS_PER_PAGE - 1;

      // Aplicar filtro de data na query principal
      if (!filters.dataFimSegundoLeilao) {
        query = query.or(
          `data_leilao_1.is.null,` +
          `data_leilao_1.gte.${currentDate.toISOString()},` +
          `data_leilao_2.gte.${currentDate.toISOString()}`
        );
      }

      // PASSO 7: Executar query final
      const { data, error } = await query
        .range(from, to)                           // Pagina√ß√£o
        .order('data_leilao_1', { ascending: true }); // Ordenar por data

      if (error) throw error;

      // PASSO 8: Formatar e exibir resultados
      setProperties(data || []);
    };

    fetchProperties();
  }, [currentPage, filters, filtersLoaded]);

  // Fun√ß√£o para aplicar novos filtros
  const applyFilters = (newFilters: FilterParams) => {
    setFilters(newFilters);
    updateURL(newFilters);  // Atualiza URL
    setCurrentPage(1);       // Volta para primeira p√°gina
  };

  return (
    <div>
      {/* Seus componentes de filtro aqui */}
      {/* Lista de im√≥veis */}
      {/* Pagina√ß√£o */}
    </div>
  );
};
```

---

## üìä Mapeamento: URL ‚Üî Filtros ‚Üî Query SQL

### Exemplo 1: URL Simples

**URL:** `?cidade=Rio de Janeiro&tipo=Apartamento`

**Filtros (objeto):**
```typescript
{
  city: "Rio de Janeiro",
  type: "Apartamento"
}
```

**Query SQL gerada:**
```sql
SELECT * FROM leiloes_imoveis_com_zona
WHERE estado = 'RJ'
  AND leilao_1 >= 75000
  AND cidade = 'Rio de Janeiro'
  AND tipo_propriedade = 'Apartamento'
  AND (data_leilao_1 IS NULL OR data_leilao_1 >= NOW() OR data_leilao_2 >= NOW())
ORDER BY data_leilao_1 ASC
LIMIT 40 OFFSET 0;
```

### Exemplo 2: M√∫ltiplos Valores

**URL:** `?cidades=Rio de Janeiro,Niter√≥i&tipo=Casa,Apartamento`

**Filtros:**
```typescript
{
  cities: ["Rio de Janeiro", "Niter√≥i"],
  type: "Casa,Apartamento"
}
```

**Query SQL:**
```sql
WHERE cidade IN ('Rio de Janeiro', 'Niter√≥i')
  AND tipo_propriedade IN ('Casa', 'Apartamento')
```

### Exemplo 3: Busca com OR

**URL:** `?localizacao=Ipanema&palavra_chave=mar`

**Filtros:**
```typescript
{
  location: "Ipanema",
  keyword: "mar"
}
```

**Query SQL:**
```sql
WHERE (endereco ILIKE '%Ipanema%' OR bairro ILIKE '%Ipanema%' OR cidade ILIKE '%Ipanema%')
  AND (titulo_propriedade ILIKE '%mar%' OR descricao ILIKE '%mar%')
```

### Exemplo 4: Filtros Booleanos

**URL:** `?financiamento=true&fgts=true&preco_min=200000&preco_max=500000`

**Filtros:**
```typescript
{
  financiamento: true,
  fgts: true,
  priceRange: { min: 200000, max: 500000 }
}
```

**Query SQL:**
```sql
WHERE financiamento = true
  AND fgts = true
  AND leilao_1 >= 200000
  AND leilao_1 <= 500000
```

---

## üîç Detalhamento de Cada Filtro

### 1. Filtro de Cidade

**Como funciona:**
- Se uma cidade: `query.eq('cidade', 'Rio de Janeiro')`
- Se m√∫ltiplas: `query.in('cidade', ['Rio', 'Niter√≥i'])`

**URL:** `?cidade=Rio de Janeiro` ou `?cidades=Rio de Janeiro,Niter√≥i`

**Campo no banco:** `cidade` (text)

---

### 2. Filtro de Tipo de Im√≥vel

**Como funciona:**
- Se um tipo: `query.eq('tipo_propriedade', 'Apartamento')`
- Se m√∫ltiplos: `query.in('tipo_propriedade', ['Casa', 'Apartamento'])`

**URL:** `?tipo=Apartamento` ou `?tipo=Casa,Apartamento`

**Campo no banco:** `tipo_propriedade` (text)

**Valores comuns:** "Apartamento", "Casa", "Terreno", "Sala Comercial"

---

### 3. Filtro de Bairro

**Como funciona:**
- Se um bairro: `query.eq('bairro', 'Copacabana')`
- Se m√∫ltiplos: `query.in('bairro', ['Copacabana', 'Ipanema'])`

**URL:** `?bairro=Copacabana` ou `?bairros=Copacabana,Ipanema`

**Campo no banco:** `bairro` (text)

---

### 4. Filtro de Zona

**Como funciona:**
- Expande zona para lista de bairros
- Exemplo: "Zona Sul" ‚Üí ['Copacabana', 'Ipanema', 'Leblon', ...]
- Aplica: `query.in('bairro', bairrosDaZona)`

**URL:** `?zona=Zona Sul (Rio de Janeiro)`

**Campo no banco:** `bairro` (expandido)

**Zonas dispon√≠veis (RJ):**
- Zona Sul, Zona Norte, Zona Oeste, Zona Central
- Baixada Fluminense
- Regi√µes de Niter√≥i
- √Åreas especiais (Grande Tijuca, Grande M√©ier, etc.)

---

### 5. Filtro de Localiza√ß√£o (Busca Livre)

**Como funciona:**
- Busca case-insensitive em 3 campos (OR)
- Query: `query.or('endereco.ilike.%termo%,bairro.ilike.%termo%,cidade.ilike.%termo%')`
- Termo √© sanitizado e escapado

**URL:** `?localizacao=Ipanema`

**Campos no banco:** `endereco`, `bairro`, `cidade`

**Exemplo:** Busca "Ipanema" encontra:
- Endere√ßo: "Rua Ipanema, 123"
- Bairro: "Ipanema"
- Cidade: "Ipanema"

---

### 6. Filtro de Palavra-chave

**Como funciona:**
- Busca case-insensitive em 2 campos (OR)
- Query: `query.or('titulo_propriedade.ilike.%termo%,descricao.ilike.%termo%')`
- Termo √© sanitizado e escapado

**URL:** `?palavra_chave=mar`

**Campos no banco:** `titulo_propriedade`, `descricao`

**Exemplo:** Busca "mar" encontra:
- T√≠tulo: "Apartamento com vista para o mar"
- Descri√ß√£o: "Localizado pr√≥ximo ao mar"

---

### 7. Filtro de Faixa de Pre√ßo

**Como funciona:**
- `min`: `query.gte('leilao_1', min)` (maior ou igual)
- `max`: `query.lte('leilao_1', max)` (menor ou igual)
- Se ambos: aplica os dois (AND)

**URL:** `?preco_min=200000&preco_max=500000`

**Campo no banco:** `leilao_1` (number)

**Valor m√≠nimo obrigat√≥rio:** R$ 75.000 (sempre aplicado)

---

### 8. Filtro de Tipo de Leil√£o

**Como funciona:**
- **"Judicial"**: `query.in('tipo_leilao', ['Judicial', 'Outros'])`
- **"EXTRAJUDICIAL_CUSTOM"**: `query.neq('tipo_leilao', 'Judicial').neq('tipo_leilao', 'Outros')`
- **Outros**: `query.eq('tipo_leilao', valor)`

**URL:** `?tipo_leilao=Judicial` ou `?tipo_leilao=EXTRAJUDICIAL_CUSTOM`

**Campo no banco:** `tipo_leilao` (text)

**Valores:** "Judicial", "Extrajudicial", "Outros", "CAIXA"

---

### 9. Filtro de Segundo Leil√£o

**Como funciona:**
- Apenas im√≥veis que T√äM segundo leil√£o definido
- Query: `query.not('data_leilao_2', 'is', null).not('leilao_2', 'is', null)`

**URL:** `?segundo_leilao=true`

**Campos no banco:** `data_leilao_2`, `leilao_2`

---

### 10. Filtro de Financiamento

**Como funciona:**
- `query.eq('financiamento', true)`

**URL:** `?financiamento=true`

**Campo no banco:** `financiamento` (boolean)

---

### 11. Filtro de FGTS

**Como funciona:**
- `query.eq('fgts', true)`

**URL:** `?fgts=true`

**Campo no banco:** `fgts` (boolean)

---

### 12. Filtro de Parcelamento

**Como funciona:**
- `query.eq('parcelamento', true)`

**URL:** `?parcelamento=true`

**Campo no banco:** `parcelamento` (boolean)

---

### 13. Filtro de Data Final do Segundo Leil√£o

**Como funciona:**
- `query.lte('data_leilao_2', data)` (menor ou igual)
- Se n√£o houver segundo leil√£o, usa primeiro como fallback

**URL:** `?data_fim_segundo_leilao=2024-12-31`

**Campo no banco:** `data_leilao_2` (date/timestamp)

---

### 14. Filtro Autom√°tico: Apenas Leil√µes Futuros

**Como funciona:**
- Aplicado automaticamente (exceto se `dataFimSegundoLeilao` estiver definido)
- Query: `query.or('data_leilao_1.is.null,data_leilao_1.gte.hoje,data_leilao_2.gte.hoje')`
- Inclui leil√µes sem data (null) ou com data futura

**N√£o precisa ser passado na URL** - √© autom√°tico

---

## üîÑ Fluxo Completo de uma Busca

### Cen√°rio: Usu√°rio busca "Apartamentos em Copacabana at√© R$ 500k"

1. **Usu√°rio preenche filtros na interface**
   ```typescript
   {
     type: "Apartamento",
     neighborhood: "Copacabana",
     priceRange: { max: 500000 }
   }
   ```

2. **Sistema atualiza URL**
   ```
   ?tipo=Apartamento&bairro=Copacabana&preco_max=500000
   ```

3. **Hook l√™ URL e converte para filtros**
   ```typescript
   const filters = parseFiltersFromURL();
   // { type: "Apartamento", neighborhood: "Copacabana", priceRange: { max: 500000 } }
   ```

4. **Estado √© atualizado**
   ```typescript
   setFilters(filters);
   ```

5. **useEffect detecta mudan√ßa e busca dados**
   ```typescript
   useEffect(() => {
     fetchProperties();
   }, [filters]);
   ```

6. **Query √© constru√≠da sequencialmente**
   ```typescript
   let query = supabase.from('leiloes_imoveis_com_zona')
     .eq('estado', 'RJ')
     .gte('leilao_1', 75000)
     .eq('tipo_propriedade', 'Apartamento')
     .eq('bairro', 'Copacabana')
     .lte('leilao_1', 500000)
     .or('data_leilao_1.is.null,data_leilao_1.gte.hoje,data_leilao_2.gte.hoje');
   ```

7. **Contagem total √© obtida**
   ```typescript
   const countResult = await query.select('*', { count: 'exact' });
   // Exemplo: 150 im√≥veis encontrados
   ```

8. **Pagina√ß√£o √© aplicada**
   ```typescript
   const from = (currentPage - 1) * 40;  // 0
   const to = from + 40 - 1;            // 39
   query = query.range(from, to);
   ```

9. **Query final √© executada**
   ```typescript
   const { data } = await query.order('data_leilao_1', { ascending: true });
   // Retorna 40 im√≥veis (p√°gina 1)
   ```

10. **Resultados s√£o formatados e exibidos**
    ```typescript
    setProperties(formattedProperties);
    setTotalCount(150);
    setTotalPages(4); // 150 / 40 = 3.75 ‚Üí 4 p√°ginas
    ```

---

## üìÑ Estrutura da Tabela no Banco

### View: `leiloes_imoveis_com_zona`

| Campo | Tipo | Descri√ß√£o | Usado em |
|-------|------|-----------|----------|
| `id` | number | ID √∫nico | Identifica√ß√£o |
| `titulo_propriedade` | string | T√≠tulo | Filtro keyword |
| `endereco` | string | Endere√ßo completo | Filtro location |
| `bairro` | string | Bairro | Filtros neighborhood, zone, location |
| `cidade` | string | Cidade | Filtros city, location |
| `estado` | string | Estado (RJ/SP) | Filtro base |
| `data_leilao_1` | date | Data do 1¬∫ leil√£o | Filtro data futura, ordena√ß√£o |
| `data_leilao_2` | date | Data do 2¬∫ leil√£o | Filtros hasSecondAuction, dataFimSegundoLeilao |
| `leilao_1` | number | Valor do 1¬∫ leil√£o | Filtros priceRange, valor m√≠nimo |
| `leilao_2` | number | Valor do 2¬∫ leil√£o | Filtro hasSecondAuction |
| `tipo_propriedade` | string | Tipo (Casa, Apartamento, etc.) | Filtro type |
| `tipo_leilao` | string | Judicial, Extrajudicial, etc. | Filtro auctionType |
| `descricao` | text | Descri√ß√£o do im√≥vel | Filtro keyword |
| `imagem` | string | URL da imagem | Exibi√ß√£o |
| `financiamento` | boolean | Aceita financiamento | Filtro financiamento |
| `fgts` | boolean | Aceita FGTS | Filtro fgts |
| `parcelamento` | boolean | Permite parcelamento | Filtro parcelamento |

---

## üéØ Par√¢metros da URL (Mapeamento Completo)

| Par√¢metro URL | Campo Filtro | Tipo | Exemplo |
|--------------|--------------|------|---------|
| `cidade` | `city` | string | `?cidade=Rio de Janeiro` |
| `cidades` | `cities` | string[] | `?cidades=Rio,Niter√≥i` |
| `bairro` | `neighborhood` | string | `?bairro=Copacabana` |
| `bairros` | `neighborhoods` | string[] | `?bairros=Copacabana,Ipanema` |
| `zona` | `zone` | string | `?zona=Zona Sul (Rio de Janeiro)` |
| `zonas` | `zones` | string[] | `?zonas=Zona Sul,Zona Norte` |
| `localizacao` | `location` | string | `?localizacao=Ipanema` |
| `tipo` | `type` | string | `?tipo=Apartamento` |
| `palavra_chave` | `keyword` | string | `?palavra_chave=mar` |
| `preco_min` | `priceRange.min` | number | `?preco_min=200000` |
| `preco_max` | `priceRange.max` | number | `?preco_max=500000` |
| `faixas_preco` | `priceRanges` | string[] | `?faixas_preco=At√© 300k,300k-500k` |
| `tipo_leilao` | `auctionType` | string | `?tipo_leilao=Judicial` |
| `segundo_leilao` | `hasSecondAuction` | boolean | `?segundo_leilao=true` |
| `financiamento` | `financiamento` | boolean | `?financiamento=true` |
| `fgts` | `fgts` | boolean | `?fgts=true` |
| `parcelamento` | `parcelamento` | boolean | `?parcelamento=true` |
| `data_fim_segundo_leilao` | `dataFimSegundoLeilao` | string (ISO) | `?data_fim_segundo_leilao=2024-12-31` |

---

## üîê Seguran√ßa

### 1. Sanitiza√ß√£o de Inputs

**Problema:** Usu√°rio pode digitar caracteres perigosos
```typescript
// ‚ùå PERIGOSO
const location = "'; DROP TABLE leiloes_imoveis; --";

// ‚úÖ SEGURO
const sanitized = sanitizeSearchInput(location);
// Remove v√≠rgulas, ponto e v√≠rgula, espa√ßos extras
```

### 2. Escape SQL

**Problema:** Caracteres especiais do SQL podem quebrar a query
```typescript
// ‚ùå PERIGOSO
const termo = "50% desconto";
query.ilike(`%${termo}%`);  // % √© caractere especial!

// ‚úÖ SEGURO
const escaped = escapeSqlLike(termo);  // "50\% desconto"
query.ilike(`%${escaped}%`);
```

### 3. Valida√ß√£o de Tipos

**Problema:** Valores num√©ricos podem ser inv√°lidos
```typescript
// ‚úÖ SEGURO
const minPrice = searchParams.get('preco_min');
if (minPrice) {
  const parsed = parseInt(minPrice);
  if (!isNaN(parsed)) {
    filters.priceRange.min = parsed;
  }
}
```

---

## ‚ö° Performance

### Otimiza√ß√µes Implementadas

1. **Filtros no servidor** (n√£o no cliente)
   - Banco processa 16k itens em <1 segundo
   - Apenas 40 itens s√£o retornados por p√°gina

2. **Pagina√ß√£o eficiente**
   - `LIMIT 40 OFFSET 0` - busca apenas o necess√°rio
   - N√£o carrega todos os 16k itens

3. **Contagem separada**
   - Contagem total sem buscar dados
   - `select('*', { count: 'exact' })`

4. **√çndices no banco** (recomendado)
   ```sql
   CREATE INDEX idx_cidade ON leiloes_imoveis(cidade);
   CREATE INDEX idx_bairro ON leiloes_imoveis(bairro);
   CREATE INDEX idx_tipo_propriedade ON leiloes_imoveis(tipo_propriedade);
   CREATE INDEX idx_leilao_1 ON leiloes_imoveis(leilao_1);
   CREATE INDEX idx_data_leilao_1 ON leiloes_imoveis(data_leilao_1);
   ```

---

## üêõ Troubleshooting

### Problema: Filtros n√£o funcionam

**Causa:** Filtros n√£o est√£o sendo aplicados na query

**Solu√ß√£o:**
```typescript
// Verificar se filtros est√£o sendo lidos
console.log('Filtros:', filters);

// Verificar se query est√° sendo constru√≠da
console.log('Query:', query);
```

### Problema: Busca muito lenta

**Causa:** Falta de √≠ndices no banco

**Solu√ß√£o:** Criar √≠ndices nos campos filtrados (veja se√ß√£o Performance)

### Problema: SQL Injection

**Causa:** N√£o est√° usando `escapeSqlLike` e `sanitizeSearchInput`

**Solu√ß√£o:** Sempre sanitizar e escapar inputs de busca

### Problema: Pagina√ß√£o incorreta

**Causa:** Contagem total n√£o est√° sendo calculada

**Solu√ß√£o:** Verificar se `count: 'exact'` est√° na query

---

## üìö Resumo Executivo

### O que o sistema faz:

1. **L√™ filtros da URL** ‚Üí Converte para objeto
2. **Aplica filtros na query** ‚Üí Constr√≥i query SQL
3. **Executa no Supabase** ‚Üí Retorna resultados
4. **Formata dados** ‚Üí Exibe na interface
5. **Atualiza URL** ‚Üí Permite compartilhamento

### Tecnologias:

- **React** + **TypeScript** (frontend)
- **Supabase** (PostgreSQL) (backend)
- **React Router** (gerenciamento de URL)

### Volume:

- **16.000 im√≥veis** no banco
- **40 itens por p√°gina**
- **<1 segundo** de resposta

### Filtros dispon√≠veis:

- Localiza√ß√£o (cidade, bairro, zona, busca livre)
- Tipo de im√≥vel
- Pre√ßo (faixa)
- Tipo de leil√£o
- Caracter√≠sticas (financiamento, FGTS, parcelamento)
- Data (segundo leil√£o, leil√µes futuros)
- Busca por texto (t√≠tulo, descri√ß√£o)

---

## ‚úÖ Checklist de Implementa√ß√£o

- [ ] Instalar `@supabase/supabase-js` e `react-router-dom`
- [ ] Criar `useFilterParams.tsx`
- [ ] Criar `client.ts` com credenciais do Supabase
- [ ] Criar `stringUtils.ts`
- [ ] Implementar l√≥gica de busca (exemplo completo)
- [ ] Criar componentes de filtro na UI
- [ ] Testar cada filtro individualmente
- [ ] Testar m√∫ltiplos filtros combinados
- [ ] Testar pagina√ß√£o
- [ ] Testar URLs compartilh√°veis
- [ ] Adicionar √≠ndices no banco (opcional, mas recomendado)

---

**Fim da Documenta√ß√£o**

Este documento cont√©m **tudo** que voc√™ precisa saber sobre o sistema de filtros. Qualquer d√∫vida, consulte a se√ß√£o espec√≠fica acima.

